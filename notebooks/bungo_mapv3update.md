
# Bungo Map System v3 データ構造改善仕様書

## 1. 背景と目的

現在の「Bungo Map System v3」は、原作に登場する地名と関連する文章を地図上にプロットするWebアプリケーションである。しかし、現在のデータ構造は、データの冗長性や表現力の限界といった課題を抱えている。

本仕様書は、システムのデータ構造を根本的に改善し、データの正確性、管理性、および将来の拡張性を向上させることを目的とする。

## 2. 現状の課題

現在のデータ構造は「地名と文が1:1」の関係で登録されており、以下の問題を引き起こしている。

-   **課題1: データの冗長性**
    -   同じ地名が複数のレコードに重複して登録されており、データ不整合のリスクやAPIの非効率性を招いている。
    -   例：「横浜ランドマークタワー」という地名情報が、関連する文の数だけ重複して存在する。

-   **課題2: 表現力の限界**
    -   一つの文に複数の地名が含まれる場合（例：「武装探偵社からポートマフィアのビルまで...」）、これを表現するために同じ文を地名の数だけ重複登録する必要があり、非効率的である。

-   **課題3: メンテナンス性の低さ**
    -   地名の情報を更新する際、関連する全てのレコードを修正する必要があり、手間と更新漏れのリスクが大きい。
    -   表記揺れ（例：「ランドマークタワー」と「タワー」）を吸収する仕組みがない。

## 3. 提案仕様: データモデルの正規化 (1:N構造への移行)

現在の「文と地名が1:1」の構造を廃止し、**「一つの文(1)が、複数の地名(N)を参照する」**という正規化されたデータモデルに移行する。

### 3.1. 新しいAPIスキーマ設計

バックエンドとなるMicroCMSに、以下の2つのAPIを定義する。

#### a. 地名API (`places`)

地名に関するマスターデータを一元管理する。

| フィールド名 | 型 | 説明 | 例 |
| :--- | :--- | :--- | :--- |
| `id` | (自動生成) | レコードの一意なID | `landmark-tower` |
| `name` | テキスト | 地名の正式名称 | `横浜ランドマークタワー` |
| `aliases` | テキスト(複数行) | 別名や通称（表記揺れ吸収用） | `ランドマークタワー` <br> `タワー` |
| `location`| 地図 | 緯度・経度情報 | `{ latitude: 35.45, longitude: 139.63 }` |
| `description`| リッチエディタ| 地名の説明文 | `横浜のシンボル的な超高層ビル...` |
| `image` | 画像 | 地名の写真 | (画像ファイル) |

#### b. 引用文API (`quotes`)

原作の文章と、それに関連する地名（複数）を管理する。

| フィールド名 | 型 | 説明 | 例 |
| :--- | :--- | :--- | :--- |
| `id` | (自動生成) | レコードの一意なID | `quote-001` |
| `sentence` | テキスト(複数行) | 原作からの引用文 | `"探偵社からタワーへ向かった"` |
| `places` | **コンテンツ参照 (複数選択)** | 関連する地名を`places` APIから複数選択 | `[ "ada-building", "landmark-tower" ]` |
| `source` | テキスト | 出典情報（巻数、ページなど） | `原作XX巻 p.XX` |

### 3.2. フロントエンドの処理フロー

1.  **データ取得:** アプリケーション起動時に、`places` APIと `quotes` APIの両方から全データを取得する。
2.  **マーカープロット:** `places` APIのデータを元に、地図上にマーカーをプロットする。
3.  **情報表示:** ユーザーが地図上のマーカー（地名）をクリックすると、その地名IDを`places`フィールドに含む`quotes`を全て抽出し、サイドバーに一覧表示する。

## 4. 実装タスク

本仕様への移行には、以下のタスクが必要となる。

1.  **バックエンド (MicroCMS) の設定:**
    -   上記仕様に基づき、`places` APIと`quotes` APIを新規作成する。

2.  **データ移行:**
    -   既存のデータベースから全データをエクスポートする。
    -   重複を除いたユニークな地名リストを作成し、`places` APIに登録する。
    -   各文を`quotes` APIに登録し、関連する地名IDを紐付ける。
    -   上記を自動実行するデータ移行スクリプトを作成・実行する。

3.  **フロントエンドの改修:**
    -   APIからデータを取得するロジックを、新しい2つのAPIに対応させる。
    -   マーカーのクリックイベントで、関連する複数の引用文を正しくフィルタリングして表示するロジックを実装する。
    -   UIコンポーネントを新しいデータ構造に合わせて修正する。

## 5. 期待される効果

この改修により、以下の効果が期待される。

-   **データの整合性向上:** 地名情報が一元管理されるため、データ不整合のリスクがなくなる。
-   **パフォーマンス改善:** APIレスポンスから不要な重複データがなくなり、データ転送量が削減される。
-   **豊かなユーザー体験:**
    -   一つの地名に関連する全てのシーンを一覧でき、作品への理解が深まる。
    -   一つの文章から複数の聖地をたどることができる。
-   **メンテナンス性の向上:** 地名や引用文の追加・更新が容易かつ安全になる。
-   **将来の拡張性:** キャラクターや組織など、新たな要素との関連付けも容易になる基盤が整う。