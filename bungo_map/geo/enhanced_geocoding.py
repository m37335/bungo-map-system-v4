#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ—ºï¸ å¼·åŒ–ç‰ˆã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹
æ–‡è±ªåœ°å›³ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå°‚ç”¨ - æ—¥æœ¬æ–‡å­¦åœ°åå¯¾å¿œç‰ˆ

Features:
- æ–‡å­¦ä½œå“ã«é »å‡ºã™ã‚‹åœ°åã®é«˜ç²¾åº¦å¯¾å¿œ
- æ­´å²çš„åœ°åã®ç¾ä»£åº§æ¨™ãƒãƒƒãƒ”ãƒ³ã‚°
- è¤‡åˆåœ°åï¼ˆéƒ½é“åºœçœŒ+å¸‚åŒºç”ºæ‘ï¼‰å¯¾å¿œ
- é’ç©ºæ–‡åº«ã‚¯ãƒªãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå¯¾å¿œ
"""

from dataclasses import dataclass
from typing import Optional, Dict, Tuple
import re
import logging

logger = logging.getLogger(__name__)

@dataclass
class GeocodingResult:
    """ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµæœ"""
    place_name: str
    latitude: float
    longitude: float
    confidence: float
    source: str
    prefecture: Optional[str] = None
    city: Optional[str] = None

class EnhancedGeocodingService:
    """å¼·åŒ–ç‰ˆã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹"""
    
    def __init__(self):
        # éƒ½é“åºœçœŒåº§æ¨™ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
        self.prefecture_coordinates = {
            "åŒ—æµ·é“": (43.2203, 142.8635, 0.95),
            "é’æ£®": (40.5606, 140.6740, 0.95), "é’æ£®çœŒ": (40.5606, 140.6740, 0.95),
            "å²©æ‰‹": (39.7036, 141.1527, 0.95), "å²©æ‰‹çœŒ": (39.7036, 141.1527, 0.95),
            "å®®åŸ": (38.7472, 140.9739, 0.95), "å®®åŸçœŒ": (38.7472, 140.9739, 0.95),
            "ç§‹ç”°": (39.2180, 140.1024, 0.95), "ç§‹ç”°çœŒ": (39.2180, 140.1024, 0.95),
            "å±±å½¢": (38.6503, 140.3389, 0.95), "å±±å½¢çœŒ": (38.6503, 140.3389, 0.95),
            "ç¦å³¶": (37.4000, 140.2220, 0.95), "ç¦å³¶çœŒ": (37.4000, 140.2220, 0.95),
            "èŒ¨åŸ": (36.3418, 140.4469, 0.95), "èŒ¨åŸçœŒ": (36.3418, 140.4469, 0.95),
            "æ ƒæœ¨": (36.5658, 139.8835, 0.95), "æ ƒæœ¨çœŒ": (36.5658, 139.8835, 0.95),
            "ç¾¤é¦¬": (36.3914, 139.0606, 0.95), "ç¾¤é¦¬çœŒ": (36.3914, 139.0606, 0.95),
            "åŸ¼ç‰": (35.8617, 139.6455, 0.95), "åŸ¼ç‰çœŒ": (35.8617, 139.6455, 0.95),
            "åƒè‘‰": (35.6074, 140.1065, 0.95), "åƒè‘‰çœŒ": (35.6074, 140.1065, 0.95),
            "æ±äº¬": (35.6762, 139.6503, 0.98), "æ±äº¬éƒ½": (35.6762, 139.6503, 0.98),
            "ç¥å¥ˆå·": (35.4478, 139.6425, 0.95), "ç¥å¥ˆå·çœŒ": (35.4478, 139.6425, 0.95),
            "æ–°æ½Ÿ": (37.5024, 138.9109, 0.95), "æ–°æ½ŸçœŒ": (37.5024, 138.9109, 0.95),
            "å¯Œå±±": (36.6959, 137.2119, 0.95), "å¯Œå±±çœŒ": (36.6959, 137.2119, 0.95),
            "çŸ³å·": (36.2948, 136.6257, 0.95), "çŸ³å·çœŒ": (36.2948, 136.6257, 0.95),
            "ç¦äº•": (35.9438, 136.1881, 0.95), "ç¦äº•çœŒ": (35.9438, 136.1881, 0.95),
            "å±±æ¢¨": (35.6635, 138.5684, 0.95), "å±±æ¢¨çœŒ": (35.6635, 138.5684, 0.95),
            "é•·é‡": (36.2048, 138.0518, 0.95), "é•·é‡çœŒ": (36.2048, 138.0518, 0.95),
            "å²é˜œ": (35.4437, 136.7624, 0.95), "å²é˜œçœŒ": (35.4437, 136.7624, 0.95),
            "é™å²¡": (34.9756, 138.3827, 0.95), "é™å²¡çœŒ": (34.9756, 138.3827, 0.95),
            "æ„›çŸ¥": (35.1815, 136.9066, 0.95), "æ„›çŸ¥çœŒ": (35.1815, 136.9066, 0.95),
            "ä¸‰é‡": (34.7309, 136.5085, 0.95), "ä¸‰é‡çœŒ": (34.7309, 136.5085, 0.95),
            "æ»‹è³€": (35.2042, 135.8694, 0.95), "æ»‹è³€çœŒ": (35.2042, 135.8694, 0.95),
            "äº¬éƒ½": (35.0116, 135.7681, 0.98), "äº¬éƒ½åºœ": (35.0116, 135.7681, 0.98),
            "å¤§é˜ª": (34.6937, 135.5023, 0.98), "å¤§é˜ªåºœ": (34.6937, 135.5023, 0.98),
            "å…µåº«": (34.8406, 134.6956, 0.95), "å…µåº«çœŒ": (34.8406, 134.6956, 0.95),
            "å¥ˆè‰¯": (34.6851, 135.8325, 0.95), "å¥ˆè‰¯çœŒ": (34.6851, 135.8325, 0.95),
            "å’Œæ­Œå±±": (34.2261, 135.1675, 0.95), "å’Œæ­Œå±±çœŒ": (34.2261, 135.1675, 0.95),
            "é³¥å–": (35.3838, 134.2356, 0.95), "é³¥å–çœŒ": (35.3838, 134.2356, 0.95),
            "å³¶æ ¹": (35.4723, 133.0505, 0.95), "å³¶æ ¹çœŒ": (35.4723, 133.0505, 0.95),
            "å²¡å±±": (34.7549, 133.8229, 0.95), "å²¡å±±çœŒ": (34.7549, 133.8229, 0.95),
            "åºƒå³¶": (34.3963, 132.4596, 0.95), "åºƒå³¶çœŒ": (34.3963, 132.4596, 0.95),
            "å±±å£": (34.3415, 131.4763, 0.95), "å±±å£çœŒ": (34.3415, 131.4763, 0.95),
            "å¾³å³¶": (34.0658, 134.5593, 0.95), "å¾³å³¶çœŒ": (34.0658, 134.5593, 0.95),
            "é¦™å·": (34.3401, 134.0431, 0.95), "é¦™å·çœŒ": (34.3401, 134.0431, 0.95),
            "æ„›åª›": (33.5904, 132.9270, 0.95), "æ„›åª›çœŒ": (33.5904, 132.9270, 0.95),
            "é«˜çŸ¥": (33.4473, 133.5319, 0.95), "é«˜çŸ¥çœŒ": (33.4473, 133.5319, 0.95),
            "ç¦å²¡": (33.6064, 130.4181, 0.95), "ç¦å²¡çœŒ": (33.6064, 130.4181, 0.95),
            "ä½è³€": (33.2494, 130.2989, 0.95), "ä½è³€çœŒ": (33.2494, 130.2989, 0.95),
            "é•·å´": (32.7503, 129.8681, 0.95), "é•·å´çœŒ": (32.7503, 129.8681, 0.95),
            "ç†Šæœ¬": (32.7898, 130.7417, 0.95), "ç†Šæœ¬çœŒ": (32.7898, 130.7417, 0.95),
            "å¤§åˆ†": (33.2382, 131.6126, 0.95), "å¤§åˆ†çœŒ": (33.2382, 131.6126, 0.95),
            "å®®å´": (31.9110, 131.4233, 0.95), "å®®å´çœŒ": (31.9110, 131.4233, 0.95),
            "é¹¿å…å³¶": (31.5601, 130.5581, 0.95), "é¹¿å…å³¶çœŒ": (31.5601, 130.5581, 0.95),
            "æ²–ç¸„": (26.2124, 127.6792, 0.95), "æ²–ç¸„çœŒ": (26.2124, 127.6792, 0.95),
        }
        
        # ä¸»è¦éƒ½å¸‚åº§æ¨™ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
        self.city_coordinates = {
            # æ–‡å­¦ä½œå“ã«ã‚ˆãç™»å ´ã™ã‚‹éƒ½å¸‚
            "æ±äº¬": (35.6762, 139.6503, 0.98, "æ±äº¬éƒ½"),
            "æ±Ÿæˆ¸": (35.6762, 139.6503, 0.92, "æ±äº¬éƒ½"),  # æ­´å²çš„åç§°
            "äº¬éƒ½": (35.0116, 135.7681, 0.98, "äº¬éƒ½åºœ"),
            "å¹³å®‰äº¬": (35.0116, 135.7681, 0.90, "äº¬éƒ½åºœ"),  # æ­´å²çš„åç§°
            "å¤§é˜ª": (34.6937, 135.5023, 0.98, "å¤§é˜ªåºœ"),
            "å¤§å‚": (34.6937, 135.5023, 0.92, "å¤§é˜ªåºœ"),  # æ­´å²çš„åç§°
            "åå¤å±‹": (35.1815, 136.9066, 0.95, "æ„›çŸ¥çœŒ"),
            "æ¨ªæµœ": (35.4478, 139.6425, 0.95, "ç¥å¥ˆå·çœŒ"),
            "ç¥æˆ¸": (34.6901, 135.1956, 0.95, "å…µåº«çœŒ"),
            "æœ­å¹Œ": (43.0642, 141.3469, 0.95, "åŒ—æµ·é“"),
            "ä»™å°": (38.2682, 140.8694, 0.95, "å®®åŸçœŒ"),
            "åºƒå³¶": (34.3963, 132.4596, 0.95, "åºƒå³¶çœŒ"),
            "ç¦å²¡": (33.5904, 130.4017, 0.95, "ç¦å²¡çœŒ"),
            
            # æ–‡å­¦ä½œå“ã®èˆå°ã¨ãªã£ãŸéƒ½å¸‚
            "æ¾å±±": (33.8416, 132.7658, 0.95, "æ„›åª›çœŒ"),  # åŠã£ã¡ã‚ƒã‚“
            "é“å¾Œ": (33.8484, 132.7864, 0.90, "æ„›åª›çœŒ"),  # é“å¾Œæ¸©æ³‰
            "å°å€‰": (33.8834, 130.8751, 0.90, "ç¦å²¡çœŒ"),
            "æ–°æ©‹": (35.6657, 139.7588, 0.90, "æ±äº¬éƒ½"),
            "æµ…è‰": (35.7148, 139.7967, 0.90, "æ±äº¬éƒ½"),
            "ä¸Šé‡": (35.7180, 139.7730, 0.90, "æ±äº¬éƒ½"),
            "éŠ€åº§": (35.6724, 139.7709, 0.90, "æ±äº¬éƒ½"),
            "æ¸‹è°·": (35.6598, 139.7006, 0.90, "æ±äº¬éƒ½"),
            "æ–°å®¿": (35.6896, 139.6917, 0.90, "æ±äº¬éƒ½"),
            "æ± è¢‹": (35.7295, 139.7109, 0.90, "æ±äº¬éƒ½"),
            "å“å·": (35.6284, 139.7387, 0.90, "æ±äº¬éƒ½"),
            
            # åœ°æ–¹éƒ½å¸‚
            "é‡‘æ²¢": (36.5944, 136.6256, 0.95, "çŸ³å·çœŒ"),
            "é•·é‡": (36.6486, 138.1947, 0.95, "é•·é‡çœŒ"),
            "é™å²¡": (34.9756, 138.3827, 0.95, "é™å²¡çœŒ"),
            "ç”²åºœ": (35.6635, 138.5684, 0.95, "å±±æ¢¨çœŒ"),
            "æ´¥å’Œé‡": (34.4605, 131.7730, 0.92, "å³¶æ ¹çœŒ"),  # æ´¥å’Œé‡ç”º
            "è©": (34.4126, 131.4005, 0.90, "å±±å£çœŒ"),
            "å€‰æ•·": (34.5966, 133.7722, 0.90, "å²¡å±±çœŒ"),
            "å°¾é“": (34.4090, 133.2044, 0.90, "åºƒå³¶çœŒ"),
            "ä¸‹é–¢": (33.9517, 130.9219, 0.90, "å±±å£çœŒ"),
            "åˆ¥åºœ": (33.2849, 131.4911, 0.90, "å¤§åˆ†çœŒ"),
            "ç†±æµ·": (35.0954, 139.0738, 0.90, "é™å²¡çœŒ"),
            "éŒå€‰": (35.3194, 139.5467, 0.92, "ç¥å¥ˆå·çœŒ"),
            "å¥ˆè‰¯": (34.6851, 135.8325, 0.95, "å¥ˆè‰¯çœŒ"),
            "å’Œæ­Œå±±": (34.2261, 135.1675, 0.95, "å’Œæ­Œå±±çœŒ"),
            
            # ç‰¹åˆ¥åŒºãƒ»æ”¿ä»¤æŒ‡å®šéƒ½å¸‚ã®åŒº
            "åƒä»£ç”°åŒº": (35.6940, 139.7536, 0.95, "æ±äº¬éƒ½"),
            "ä¸­å¤®åŒº": (35.6704, 139.7744, 0.95, "æ±äº¬éƒ½"),
            "æ¸¯åŒº": (35.6581, 139.7414, 0.95, "æ±äº¬éƒ½"),
            "æ–°å®¿åŒº": (35.6896, 139.6917, 0.95, "æ±äº¬éƒ½"),
            "æ–‡äº¬åŒº": (35.7081, 139.7519, 0.95, "æ±äº¬éƒ½"),
            "å°æ±åŒº": (35.7105, 139.7794, 0.95, "æ±äº¬éƒ½"),
            "å¢¨ç”°åŒº": (35.7100, 139.8016, 0.95, "æ±äº¬éƒ½"),
            "æ±Ÿæ±åŒº": (35.6730, 139.8171, 0.95, "æ±äº¬éƒ½"),
            "å“å·åŒº": (35.6091, 139.7298, 0.95, "æ±äº¬éƒ½"),
            "ç›®é»’åŒº": (35.6332, 139.7006, 0.95, "æ±äº¬éƒ½"),
            "å¤§ç”°åŒº": (35.5608, 139.7164, 0.95, "æ±äº¬éƒ½"),
            "ä¸–ç”°è°·åŒº": (35.6464, 139.6534, 0.95, "æ±äº¬éƒ½"),
            "æ¸‹è°·åŒº": (35.6598, 139.7006, 0.95, "æ±äº¬éƒ½"),
            "ä¸­é‡åŒº": (35.7090, 139.6653, 0.95, "æ±äº¬éƒ½"),
            "æ‰ä¸¦åŒº": (35.6993, 139.6369, 0.95, "æ±äº¬éƒ½"),
            "è±Šå³¶åŒº": (35.7295, 139.7109, 0.95, "æ±äº¬éƒ½"),
            "åŒ—åŒº": (35.7536, 139.7340, 0.95, "æ±äº¬éƒ½"),
            "è’å·åŒº": (35.7362, 139.7830, 0.95, "æ±äº¬éƒ½"),
            "æ¿æ©‹åŒº": (35.7515, 139.7094, 0.95, "æ±äº¬éƒ½"),
            "ç·´é¦¬åŒº": (35.7353, 139.6521, 0.95, "æ±äº¬éƒ½"),
            "è¶³ç«‹åŒº": (35.7747, 139.8048, 0.95, "æ±äº¬éƒ½"),
            "è‘›é£¾åŒº": (35.7448, 139.8481, 0.95, "æ±äº¬éƒ½"),
            "æ±Ÿæˆ¸å·åŒº": (35.7065, 139.8683, 0.95, "æ±äº¬éƒ½"),
        }
        
        # æ­´å²çš„åœ°åãƒãƒƒãƒ”ãƒ³ã‚°
        self.historical_places = {
            "æ­¦è”µ": (35.6762, 139.6503, 0.85, "æ±äº¬éƒ½"),  # æ­¦è”µå›½ â†’ æ±äº¬
            "å±±åŸ": (35.0116, 135.7681, 0.85, "äº¬éƒ½åºœ"),  # å±±åŸå›½ â†’ äº¬éƒ½
            "æ‘‚æ´¥": (34.6937, 135.5023, 0.85, "å¤§é˜ªåºœ"),  # æ‘‚æ´¥å›½ â†’ å¤§é˜ª
            "æ²³å†…": (34.6286, 135.6020, 0.85, "å¤§é˜ªåºœ"),  # æ²³å†…å›½ â†’ å¤§é˜ªæ±éƒ¨
            "å’Œæ³‰": (34.4845, 135.4009, 0.85, "å¤§é˜ªåºœ"),  # å’Œæ³‰å›½ â†’ å¤§é˜ªå—éƒ¨
            "è¶Šå¾Œ": (37.5024, 138.9109, 0.85, "æ–°æ½ŸçœŒ"),  # è¶Šå¾Œå›½ â†’ æ–°æ½Ÿ
            "è¶Šå‰": (35.9438, 136.1881, 0.85, "ç¦äº•çœŒ"),  # è¶Šå‰å›½ â†’ ç¦äº•
            "åŠ è³€": (36.2948, 136.6257, 0.85, "çŸ³å·çœŒ"),  # åŠ è³€å›½ â†’ çŸ³å·
            "èƒ½ç™»": (37.2304, 136.8990, 0.85, "çŸ³å·çœŒ"),  # èƒ½ç™»å›½ â†’ çŸ³å·åŒ—éƒ¨
            "ä¿¡æ¿ƒ": (36.2048, 138.0518, 0.85, "é•·é‡çœŒ"),  # ä¿¡æ¿ƒå›½ â†’ é•·é‡
            "ç”²æ–": (35.6635, 138.5684, 0.85, "å±±æ¢¨çœŒ"),  # ç”²æ–å›½ â†’ å±±æ¢¨
            "ç›¸æ¨¡": (35.4478, 139.6425, 0.85, "ç¥å¥ˆå·çœŒ"),  # ç›¸æ¨¡å›½ â†’ ç¥å¥ˆå·
            "å®‰æˆ¿": (35.1147, 139.8749, 0.85, "åƒè‘‰çœŒ"),  # å®‰æˆ¿å›½ â†’ åƒè‘‰å—éƒ¨
            "ä¸Šç·": (35.4483, 140.2067, 0.85, "åƒè‘‰çœŒ"),  # ä¸Šç·å›½ â†’ åƒè‘‰ä¸­éƒ¨
            "ä¸‹ç·": (35.7723, 140.0931, 0.85, "åƒè‘‰çœŒ"),  # ä¸‹ç·å›½ â†’ åƒè‘‰åŒ—éƒ¨
            "å¸¸é™¸": (36.3418, 140.4469, 0.85, "èŒ¨åŸçœŒ"),  # å¸¸é™¸å›½ â†’ èŒ¨åŸ
            "ä¸‹é‡": (36.5658, 139.8835, 0.85, "æ ƒæœ¨çœŒ"),  # ä¸‹é‡å›½ â†’ æ ƒæœ¨
            "ä¸Šé‡": (36.3914, 139.0606, 0.85, "ç¾¤é¦¬çœŒ"),  # ä¸Šé‡å›½ â†’ ç¾¤é¦¬
            "ä¸¹æ³¢": (35.0733, 135.4429, 0.85, "äº¬éƒ½åºœ"),  # ä¸¹æ³¢å›½ â†’ äº¬éƒ½ãƒ»å…µåº«
            "ä¸¹å¾Œ": (35.5400, 135.0869, 0.85, "äº¬éƒ½åºœ"),  # ä¸¹å¾Œå›½ â†’ äº¬éƒ½åŒ—éƒ¨
            "ä½†é¦¬": (35.2326, 134.7673, 0.85, "å…µåº«çœŒ"),  # ä½†é¦¬å›½ â†’ å…µåº«åŒ—éƒ¨
            "å› å¹¡": (35.3838, 134.2356, 0.85, "é³¥å–çœŒ"),  # å› å¹¡å›½ â†’ é³¥å–æ±éƒ¨
            "ä¼¯è€†": (35.4291, 133.3309, 0.85, "é³¥å–çœŒ"),  # ä¼¯è€†å›½ â†’ é³¥å–è¥¿éƒ¨
            "å‡ºé›²": (35.3676, 132.7498, 0.85, "å³¶æ ¹çœŒ"),  # å‡ºé›²å›½ â†’ å³¶æ ¹æ±éƒ¨
            "çŸ³è¦‹": (34.6702, 131.8378, 0.85, "å³¶æ ¹çœŒ"),  # çŸ³è¦‹å›½ â†’ å³¶æ ¹è¥¿éƒ¨
            "éš å²": (36.2094, 133.3250, 0.85, "å³¶æ ¹çœŒ"),  # éš å²å›½ â†’ éš å²è«¸å³¶
            "å‚™å‰": (34.6618, 134.0048, 0.85, "å²¡å±±çœŒ"),  # å‚™å‰å›½ â†’ å²¡å±±æ±éƒ¨
            "å‚™ä¸­": (34.5966, 133.7722, 0.85, "å²¡å±±çœŒ"),  # å‚™ä¸­å›½ â†’ å²¡å±±è¥¿éƒ¨
            "å‚™å¾Œ": (34.4900, 133.1895, 0.85, "åºƒå³¶çœŒ"),  # å‚™å¾Œå›½ â†’ åºƒå³¶æ±éƒ¨
            "å®‰èŠ¸": (34.3963, 132.4596, 0.85, "åºƒå³¶çœŒ"),  # å®‰èŠ¸å›½ â†’ åºƒå³¶è¥¿éƒ¨
            "å‘¨é˜²": (34.1462, 131.4704, 0.85, "å±±å£çœŒ"),  # å‘¨é˜²å›½ â†’ å±±å£æ±éƒ¨
            "é•·é–€": (34.3778, 131.2069, 0.85, "å±±å£çœŒ"),  # é•·é–€å›½ â†’ å±±å£è¥¿éƒ¨
        }
    
    def parse_compound_place(self, place_name: str) -> Tuple[Optional[str], Optional[str]]:
        """è¤‡åˆåœ°åã®è§£æï¼ˆéƒ½é“åºœçœŒ+å¸‚åŒºç”ºæ‘ï¼‰"""
        # ãƒ‘ã‚¿ãƒ¼ãƒ³1: çœŒå+å¸‚åŒºç”ºæ‘å
        prefecture_pattern = r'(.*?[éƒ½é“åºœçœŒ])(.*)'
        match = re.match(prefecture_pattern, place_name)
        if match:
            prefecture = match.group(1)
            city = match.group(2)
            return prefecture, city
        
        return None, None
    
    def geocode_place_sync(self, place_name: str) -> Optional[GeocodingResult]:
        """åœ°åã‚’ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆåŒæœŸç‰ˆï¼‰"""
        logger.info(f"ğŸ—ºï¸ Geocoding: {place_name}")
        
        # 1. å®Œå…¨ä¸€è‡´æ¤œç´¢ï¼ˆéƒ½å¸‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å„ªå…ˆï¼‰
        if place_name in self.city_coordinates:
            lat, lng, confidence, prefecture = self.city_coordinates[place_name]
            result = GeocodingResult(
                place_name=place_name,
                latitude=lat,
                longitude=lng,
                confidence=confidence,
                source="city_database",
                prefecture=prefecture,
                city=place_name
            )
            logger.info(f"   âœ… éƒ½å¸‚DB: ({lat:.4f}, {lng:.4f}) ä¿¡é ¼åº¦:{confidence:.2f}")
            return result
        
        # 2. éƒ½é“åºœçœŒæ¤œç´¢
        if place_name in self.prefecture_coordinates:
            lat, lng, confidence = self.prefecture_coordinates[place_name]
            result = GeocodingResult(
                place_name=place_name,
                latitude=lat,
                longitude=lng,
                confidence=confidence,
                source="prefecture_database",
                prefecture=place_name
            )
            logger.info(f"   âœ… éƒ½é“åºœçœŒDB: ({lat:.4f}, {lng:.4f}) ä¿¡é ¼åº¦:{confidence:.2f}")
            return result
        
        # 3. æ­´å²çš„åœ°åæ¤œç´¢
        if place_name in self.historical_places:
            lat, lng, confidence, modern_name = self.historical_places[place_name]
            result = GeocodingResult(
                place_name=place_name,
                latitude=lat,
                longitude=lng,
                confidence=confidence,
                source="historical_database",
                prefecture=modern_name,
                city=place_name
            )
            logger.info(f"   âœ… æ­´å²åœ°åDB: ({lat:.4f}, {lng:.4f}) ä¿¡é ¼åº¦:{confidence:.2f}")
            return result
        
        # 4. è¤‡åˆåœ°åè§£æ
        prefecture, city = self.parse_compound_place(place_name)
        if prefecture and city:
            # éƒ½é“åºœçœŒåº§æ¨™ã‚’ãƒ™ãƒ¼ã‚¹ã«ã™ã‚‹
            if prefecture in self.prefecture_coordinates:
                lat, lng, confidence = self.prefecture_coordinates[prefecture]
                # å¸‚åŒºç”ºæ‘ãŒç‰¹å®šã§ãã‚Œã°åº§æ¨™èª¿æ•´
                if city in self.city_coordinates:
                    city_lat, city_lng, city_conf, _ = self.city_coordinates[city]
                    lat, lng, confidence = city_lat, city_lng, max(confidence, city_conf)
                
                result = GeocodingResult(
                    place_name=place_name,
                    latitude=lat,
                    longitude=lng,
                    confidence=confidence * 0.9,  # è¤‡åˆåœ°åã¯ä¿¡é ¼åº¦å°‘ã—ä¸‹ã’ã‚‹
                    source="compound_analysis",
                    prefecture=prefecture,
                    city=city
                )
                logger.info(f"   âœ… è¤‡åˆåœ°å: ({lat:.4f}, {lng:.4f}) ä¿¡é ¼åº¦:{confidence*0.9:.2f}")
                return result
        
        # 5. éƒ¨åˆ†ãƒãƒƒãƒãƒ³ã‚°æ¤œç´¢
        for known_name, (lat, lng, confidence, prefecture) in self.city_coordinates.items():
            if known_name in place_name or place_name in known_name:
                result = GeocodingResult(
                    place_name=place_name,
                    latitude=lat,
                    longitude=lng,
                    confidence=confidence * 0.7,  # éƒ¨åˆ†ãƒãƒƒãƒã¯ä¿¡é ¼åº¦å¤§å¹…ã«ä¸‹ã’ã‚‹
                    source="partial_match",
                    prefecture=prefecture,
                    city=known_name
                )
                logger.info(f"   âœ… éƒ¨åˆ†ãƒãƒƒãƒ: ({lat:.4f}, {lng:.4f}) ä¿¡é ¼åº¦:{confidence*0.7:.2f}")
                return result
        
        logger.warning(f"   âŒ Geocodingå¤±æ•—: {place_name}")
        return None
    
    async def geocode_place(self, place_name: str) -> Optional[GeocodingResult]:
        """åœ°åã‚’ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆéåŒæœŸç‰ˆï¼‰"""
        return self.geocode_place_sync(place_name)
    
    def get_coverage_stats(self) -> Dict[str, int]:
        """ã‚«ãƒãƒ¬ãƒƒã‚¸çµ±è¨ˆå–å¾—"""
        return {
            'prefecture_count': len(self.prefecture_coordinates),
            'city_count': len(self.city_coordinates),
            'historical_count': len(self.historical_places),
            'total_places': len(self.prefecture_coordinates) + len(self.city_coordinates) + len(self.historical_places)
        } 