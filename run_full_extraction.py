#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ–‡è±ªã‚†ã‹ã‚Šåœ°å›³ã‚·ã‚¹ãƒ†ãƒ  - å®Œå…¨ãƒ‡ãƒ¼ã‚¿æ‹¡å……ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
é’ç©ºæ–‡åº«ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰GiNZA+æ­£è¦è¡¨ç¾ã«ã‚ˆã‚‹åœ°åæŠ½å‡º + è‡ªå‹•ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
"""

import time
import sqlite3
from bungo_map.core.database import BungoDB
from bungo_map.extractors.aozora_extractor import AozoraExtractor
from bungo_map.extractors.ginza_place_extractor import GinzaPlaceExtractor
from bungo_map.extractors.simple_place_extractor import SimplePlaceExtractor


class GeocodingEngine:
    """ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ³ã‚¸ãƒ³ - æ—¥æœ¬ã®åœ°ååº§æ¨™ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹"""
    
    def __init__(self):
        # æ—¥æœ¬ã®ä¸»è¦åœ°ååº§æ¨™ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆæ‹¡å¼µç‰ˆï¼‰
        self.coordinates_db = {
            # éƒ½é“åºœçœŒãƒ»çœŒåºæ‰€åœ¨åœ°
            "æœ­å¹Œ": (43.0642, 141.3469),
            "é’æ£®": (40.8244, 140.7403),
            "ä»™å°": (38.2682, 140.8694),
            "ç§‹ç”°": (39.7186, 140.1024),
            "å±±å½¢": (38.2404, 140.3633),
            "ç¦å³¶": (37.7503, 140.4677),
            "æ°´æˆ¸": (36.3418, 140.4468),
            "å®‡éƒ½å®®": (36.5658, 139.8836),
            "å‰æ©‹": (36.3911, 139.0608),
            "ã•ã„ãŸã¾": (35.8617, 139.6455),
            "åƒè‘‰": (35.6074, 140.1065),
            "ç”²åºœ": (35.6642, 138.5684),
            "é•·é‡": (36.6513, 138.1811),
            "å²é˜œ": (35.3912, 136.7223),
            "é™å²¡": (34.9756, 138.3827),
            "æ´¥": (34.7303, 136.5086),
            "å¤§æ´¥": (35.0045, 135.8686),
            "ç¥æˆ¸": (34.6901, 135.1956),
            "å¥ˆè‰¯": (34.6851, 135.8048),
            "å’Œæ­Œå±±": (34.2261, 135.1675),
            "é³¥å–": (35.5038, 134.2384),
            "æ¾æ±Ÿ": (35.4723, 133.0505),
            "å²¡å±±": (34.6617, 133.9341),
            "å±±å£": (34.1858, 131.4706),
            "å¾³å³¶": (34.0658, 134.5594),
            "é«˜æ¾": (34.3402, 134.0434),
            "é«˜çŸ¥": (33.5597, 133.5311),
            "ç¦å²¡": (33.5904, 130.4017),
            "ä½è³€": (33.2494, 130.2989),
            "é•·å´": (32.7503, 129.8779),
            "ç†Šæœ¬": (32.7898, 130.7417),
            "å¤§åˆ†": (33.2382, 131.6126),
            "å®®å´": (31.9077, 131.4202),
            "é¹¿å…å³¶": (31.5966, 130.5571),
            "é‚£è¦‡": (26.2124, 127.6792),
            
            # æ­´å²çš„ãƒ»å¤å…¸åœ°å
            "æ­¦è”µ": (35.6762, 139.6503),  # æ±äº¬
            "ç›¸æ¨¡": (35.3392, 139.3949),  # ç¥å¥ˆå·
            "ç”²æ–": (35.6642, 138.5684),  # å±±æ¢¨
            "ä¿¡æ¿ƒ": (36.6513, 138.1811),  # é•·é‡
            "è¶Šå¾Œ": (37.9022, 139.0237),  # æ–°æ½Ÿ
            "ä¸Šé‡": (35.7090, 139.7753),  # å°æ±åŒº
            "ä¸‹é‡": (36.5658, 139.8836),  # æ ƒæœ¨
            "å¸¸é™¸": (36.3418, 140.4468),  # èŒ¨åŸ
            "ä¸Šç·": (35.3606, 140.0978),  # åƒè‘‰
            "ä¸‹ç·": (35.7167, 140.1167),  # åƒè‘‰åŒ—éƒ¨
            "å®‰æˆ¿": (35.1065, 139.8387),  # åƒè‘‰å—éƒ¨
            "ä¼Šè±†": (34.9756, 138.9473),  # é™å²¡
            "é§¿æ²³": (35.0180, 138.4106),  # é™å²¡
            "é æ±Ÿ": (34.8406, 137.8617),  # é™å²¡è¥¿éƒ¨
            "ä¸‰æ²³": (34.8606, 137.0617),  # æ„›çŸ¥æ±éƒ¨
            "å°¾å¼µ": (35.1815, 136.9066),  # æ„›çŸ¥è¥¿éƒ¨
            "ç¾æ¿ƒ": (35.3912, 136.7223),  # å²é˜œ
            "é£›é¨¨": (36.1459, 137.2511),  # å²é˜œåŒ—éƒ¨
            "è¿‘æ±Ÿ": (35.0045, 135.8686),  # æ»‹è³€
            "å±±åŸ": (35.0116, 135.7681),  # äº¬éƒ½
            "å¤§å’Œ": (34.6851, 135.8048),  # å¥ˆè‰¯
            "æ²³å†…": (34.6289, 135.6005),  # å¤§é˜ªæ±éƒ¨
            "å’Œæ³‰": (34.4851, 135.4048),  # å¤§é˜ªå—éƒ¨
            "æ‘‚æ´¥": (34.7303, 135.5086),  # å¤§é˜ªåŒ—éƒ¨
            "æ’­ç£¨": (34.8406, 134.6917),  # å…µåº«
            "ä½†é¦¬": (35.5038, 134.7384),  # å…µåº«åŒ—éƒ¨
            "ä¸¹æ³¢": (35.1723, 135.0505),  # å…µåº«ãƒ»äº¬éƒ½
            "ä¸¹å¾Œ": (35.6275, 135.1005),  # äº¬éƒ½åŒ—éƒ¨
            "è‹¥ç‹­": (35.4950, 135.9070),  # ç¦äº•
            "è¶Šå‰": (36.0653, 136.2217),  # ç¦äº•
            "åŠ è³€": (36.5944, 136.6256),  # çŸ³å·
            "èƒ½ç™»": (37.2044, 136.9656),  # çŸ³å·åŒ—éƒ¨
            "è¶Šä¸­": (36.6959, 137.2139),  # å¯Œå±±
            "ä½æ¸¡": (38.0189, 138.3669),  # æ–°æ½Ÿãƒ»ä½æ¸¡å³¶
            "å‡ºé›²": (35.3678, 132.7594),  # å³¶æ ¹
            "çŸ³è¦‹": (34.6723, 131.8505),  # å³¶æ ¹è¥¿éƒ¨
            "éš å²": (36.2044, 133.3256),  # å³¶æ ¹ãƒ»éš å²è«¸å³¶
            "å‚™å‰": (34.6617, 133.9341),  # å²¡å±±
            "å‚™ä¸­": (34.5517, 133.7541),  # å²¡å±±è¥¿éƒ¨
            "å‚™å¾Œ": (34.4017, 133.2341),  # åºƒå³¶æ±éƒ¨
            "å®‰èŠ¸": (34.3853, 132.4553),  # åºƒå³¶
            "å‘¨é˜²": (34.0658, 131.4706),  # å±±å£
            "é•·é–€": (34.3858, 131.1906),  # å±±å£åŒ—éƒ¨
            "è®ƒå²": (34.3402, 134.0434),  # é¦™å·
            "é˜¿æ³¢": (34.0658, 134.5594),  # å¾³å³¶
            "åœŸä½": (33.5597, 133.5311),  # é«˜çŸ¥
            "ä¼Šäºˆ": (33.8416, 132.7658),  # æ„›åª›
            "ç­‘å‰": (33.5904, 130.4017),  # ç¦å²¡
            "ç­‘å¾Œ": (33.2094, 130.5017),  # ç¦å²¡å—éƒ¨
            "è±Šå‰": (33.6194, 131.1017),  # ç¦å²¡ãƒ»å¤§åˆ†
            "è±Šå¾Œ": (33.2382, 131.6126),  # å¤§åˆ†
            "è‚¥å‰": (33.2494, 130.2989),  # ä½è³€ãƒ»é•·å´
            "è‚¥å¾Œ": (32.7898, 130.7417),  # ç†Šæœ¬
            "æ—¥å‘": (31.9077, 131.4202),  # å®®å´
            "å¤§éš…": (31.3066, 130.8571),  # é¹¿å…å³¶æ±éƒ¨
            "è–©æ‘©": (31.5966, 130.5571),  # é¹¿å…å³¶
            "å£±å²": (33.7494, 129.6989),  # é•·å´ãƒ»å£±å²å³¶
            "å¯¾é¦¬": (34.2049, 129.2890),  # é•·å´ãƒ»å¯¾é¦¬
            
            # ä¸»è¦éƒ½å¸‚ãƒ»æ±äº¬23åŒº
            "æ±äº¬": (35.6762, 139.6503),
            "æ¨ªæµœ": (35.4437, 139.6380),
            "å·å´": (35.5308, 139.7029),
            "åŸ¼ç‰": (35.8617, 139.6455),
            "äº¬éƒ½": (35.0116, 135.7681),
            "å¤§é˜ª": (34.6937, 135.5023),
            "åå¤å±‹": (35.1815, 136.9066),
            "ç¥æˆ¸": (34.6901, 135.1956),
            "åºƒå³¶": (34.3853, 132.4553),
            "åŒ—ä¹å·": (33.8834, 130.8751),
            "åƒä»£ç”°": (35.6938, 139.7535),
            "ä¸­å¤®": (35.6761, 139.7668),
            "æ¸¯": (35.6586, 139.7514),
            "æ–°å®¿": (35.6938, 139.7035),
            "æ–‡äº¬": (35.7081, 139.7518),
            "å°æ±": (35.7120, 139.7793),
            "å¢¨ç”°": (35.7101, 139.8007),
            "æ±Ÿæ±": (35.6731, 139.8172),
            "å“å·": (35.6297, 139.7403),
            "ç›®é»’": (35.6336, 139.7156),
            "å¤§ç”°": (35.5617, 139.7153),
            "ä¸–ç”°è°·": (35.6464, 139.6532),
            "æ¸‹è°·": (35.6581, 139.7014),
            "ä¸­é‡": (35.7090, 139.6654),
            "æ‰ä¸¦": (35.6993, 139.6368),
            "è±Šå³¶": (35.7295, 139.7156),
            "åŒ—": (35.7539, 139.7268),
            "è’å·": (35.7364, 139.7836),
            "æ¿æ©‹": (35.7511, 139.7088),
            "ç·´é¦¬": (35.7356, 139.6534),
            "è¶³ç«‹": (35.7748, 139.8048),
            "è‘›é£¾": (35.7448, 139.8487),
            "æ±Ÿæˆ¸å·": (35.7041, 139.8681),
            
            # æ±äº¬ã®è©³ç´°åœ°å
            "éº¹ç”º": (35.6816, 139.7419),
            "éº¹ç”ºè¾º": (35.6816, 139.7419),
            "ç¥ç”°": (35.6914, 139.7706),
            "å°å·ç”º": (35.6914, 139.7706),
            "çœŸç ‚ç”º": (35.6674, 139.7706),
            "æ—¥æœ¬æ©‹": (35.6812, 139.7714),
            "éŠ€åº§": (35.6762, 139.7653),
            "æ–°æ©‹": (35.6668, 139.7587),
            "æ±ç•™": (35.6627, 139.7587),
            "è™ãƒé–€": (35.6684, 139.7519),
            "èµ¤å‚": (35.6744, 139.7378),
            "é’å±±": (35.6704, 139.7195),
            "éº»å¸ƒ": (35.6518, 139.7394),
            "å…­æœ¬æœ¨": (35.6627, 139.7314),
            "æµæ¯”å¯¿": (35.6464, 139.7100),
            "æ¸‹è°·": (35.6581, 139.7014),
            "åŸå®¿": (35.6702, 139.7027),
            "è¡¨å‚é“": (35.6658, 139.7111),
            "å››è°·": (35.6884, 139.7274),
            "å¸‚ãƒ¶è°·": (35.6944, 139.7274),
            "é£¯ç”°æ©‹": (35.7017, 139.7455),
            "æ°´é“æ©‹": (35.7017, 139.7555),
            "å¾¡èŒ¶ãƒæ°´": (35.6995, 139.7661),
            "ç§‹è‘‰åŸ": (35.6980, 139.7714),
            "ä¸Šé‡": (35.7090, 139.7753),
            "æµ…è‰": (35.7148, 139.7967),
            "æŠ¼ä¸Š": (35.7101, 139.8107),
            "ä¸¡å›½": (35.6957, 139.7944),
            "éŒ¦ç³¸ç”º": (35.6969, 139.8156),
            "äº€æˆ¸": (35.6969, 139.8256),
            "æ·±å·": (35.6717, 139.8017),
            "é–€å‰ä»²ç”º": (35.6717, 139.7917),
            "æœ¨å ´": (35.6717, 139.8117),
            "è±Šæ´²": (35.6550, 139.7917),
            "æœˆå³¶": (35.6650, 139.7817),
            "å‹ã©ã": (35.6550, 139.7717),
            "ç¯‰åœ°": (35.6654, 139.7706),
            "å…«é‡æ´²": (35.6812, 139.7714),
            "ä¸¸ã®å†…": (35.6814, 139.7653),
            "å¤§æ‰‹ç”º": (35.6862, 139.7649),
            "éœãŒé–¢": (35.6743, 139.7514),
            "æ°¸ç”°ç”º": (35.6743, 139.7414),
            "æºœæ± ": (35.6743, 139.7414),
            "æœ¬éƒ·": (35.7090, 139.7619),
            "æ ¹æ´¥": (35.7219, 139.7625),
            "åƒé§„æœ¨": (35.7295, 139.7625),
            "è°·ä¸­": (35.7295, 139.7725),
            "æ—¥æš®é‡Œ": (35.7319, 139.7675),
            "è¥¿æ—¥æš®é‡Œ": (35.7319, 139.7575),
            "ç”°ç«¯": (35.7364, 139.7636),
            "é§’è¾¼": (35.7364, 139.7536),
            "å·£é´¨": (35.7339, 139.7391),
            "å¤§å¡š": (35.7314, 139.7291),
            "æ± è¢‹": (35.7295, 139.7156),
            "é«˜ç”°é¦¬å ´": (35.7126, 139.7039),
            "æ–°å¤§ä¹…ä¿": (35.7001, 139.7000),
            "æ­Œèˆä¼ç”º": (35.6938, 139.7085),
            "ç¥æ¥½å‚": (35.7017, 139.7355),
            "ä¹æ®µ": (35.6938, 139.7535),
            "é–å›½": (35.6938, 139.7435),
            "å¸‚è°·": (35.6944, 139.7274),
            "å››ãƒ„è°·": (35.6884, 139.7274),
            "ä¿¡æ¿ƒç”º": (35.6794, 139.7245),
            "åƒé§„ãƒ¶è°·": (35.6794, 139.7145),
            "ä»£ã€…æœ¨": (35.6836, 139.7019),
            "æ–°å®¿å¾¡è‹‘": (35.6851, 139.7101),
            "æ—©ç¨²ç”°": (35.7081, 139.7218),
            "é«˜ç”°": (35.7126, 139.7139),
            "ç›®ç™½": (35.7215, 139.7062),
            "é›‘å¸ãƒ¶è°·": (35.7215, 139.7162),
            "è­·å›½å¯º": (35.7215, 139.7262),
            "èŒ—è·è°·": (35.7215, 139.7362),
            "å¾Œæ¥½åœ’": (35.7067, 139.7519),
            "æ˜¥æ—¥": (35.7067, 139.7419),
            "ç™½å±±": (35.7219, 139.7525),
            "åƒçŸ³": (35.7295, 139.7525),
            
            # è¦³å…‰åœ°ãƒ»æœ‰ååœ°å
            "éŒå€‰": (35.3192, 139.5469),
            "æ±Ÿãƒå³¶": (35.2978, 139.4813),
            "ç®±æ ¹": (35.2322, 139.1069),
            "å¯Œå£«å±±": (35.3606, 138.7274),
            "æ²³å£æ¹–": (35.5022, 138.7644),
            "å±±ä¸­æ¹–": (35.4169, 138.8644),
            "è»½äº•æ²¢": (36.3427, 138.6297),
            "è‰æ´¥": (36.6225, 138.5981),
            "æ—¥å…‰": (36.7581, 139.6206),
            "è¯å³æ»": (36.7381, 139.5006),
            "ä¸­ç¦…å¯ºæ¹–": (36.7581, 139.5006),
            "é‚£é ˆ": (37.0381, 140.0406),
            "å¡©åŸ": (36.9081, 139.8406),
            "ä¼Šè±†é•·å²¡": (35.0339, 138.9439),
            "ç†±æµ·": (35.0956, 139.0773),
            "ä¼Šæ±": (34.9656, 139.1073),
            "ä¸‹ç”°": (34.6756, 138.9473),
            "ä¿®å–„å¯º": (34.9756, 138.9273),
            
            # é–¢è¥¿ã®æœ‰ååœ°å
            "æ¸…æ°´": (34.9956, 135.7831),
            "åµå±±": (35.0156, 135.6781),
            "é‡‘é–£å¯º": (35.0394, 135.7292),
            "éŠ€é–£å¯º": (35.0267, 135.7981),
            "ç¥‡åœ’": (35.0036, 135.7781),
            "ä¸‰æ¡": (35.0096, 135.7681),
            "å››æ¡": (35.0036, 135.7681),
            "æ²³åŸç”º": (35.0036, 135.7681),
            "çƒä¸¸": (35.0036, 135.7681),
            "å®‡æ²»": (34.8844, 135.7998),
            "ä¼è¦‹": (34.9289, 135.7556),
            "é›£æ³¢": (34.6661, 135.5000),
            "æ¢…ç”°": (34.7024, 135.4959),
            "å¤©ç‹å¯º": (34.6455, 135.5066),
            "ä½å‰": (34.6155, 135.4966),
            "å º": (34.5732, 135.4827),
            "å¥ˆè‰¯å…¬åœ’": (34.6851, 135.8448),
            "æ±å¤§å¯º": (34.6889, 135.8398),
            "æ˜¥æ—¥å¤§ç¤¾": (34.6819, 135.8479),
            "å‰é‡": (34.3689, 135.8698),
            "é«˜é‡å±±": (34.2139, 135.5831),
            "å’Œæ­Œæµ¦": (34.2261, 135.1975),
            "ç™½æµœ": (33.6894, 135.3367),
            
            # ä¹å·ã®æœ‰ååœ°å
            "åšå¤š": (33.5904, 130.4017),
            "å¤©ç¥": (33.5904, 130.4017),
            "å¤ªå®°åºœ": (33.5159, 130.5289),
            "å°å€‰": (33.8834, 130.8751),
            "é–€å¸": (33.9417, 130.9617),
            "ä¹…ç•™ç±³": (33.3194, 130.5089),
            "æŸ³å·": (33.1594, 130.4089),
            "æœ‰ç”°": (33.1822, 129.8811),
            "å¬‰é‡": (33.1294, 130.0589),
            "é›²ä»™": (32.7639, 130.2914),
            "å³¶åŸ": (32.7894, 130.3639),
            "é˜¿è˜‡": (32.8840, 131.1040),
            "åˆ¥åºœ": (33.2794, 131.4911),
            "æ¹¯å¸ƒé™¢": (33.2664, 131.3611),
            "é«˜åƒç©‚": (32.7122, 131.3011),
            "æŒ‡å®¿": (31.2556, 130.6450),
            "æ¡œå³¶": (31.5856, 130.6571),
            
            # ãã®ä»–ã®é‡è¦ãªåœ°å
            "æ¾å±±": (33.8416, 132.7658),
            "é“å¾Œ": (33.8516, 132.7858),
            "ä»Šæ²»": (34.0667, 132.9997),
            "å®‡å’Œå³¶": (33.2239, 132.5606),
            "é«˜çŸ¥åŸ": (33.5597, 133.5311),
            "æ¡‚æµœ": (33.4989, 133.5703),
            "å®¤æˆ¸": (33.2894, 134.1594),
            "è¶³æ‘º": (32.7311, 132.9211),
            "å¾³å³¶åŸ": (34.0658, 134.5594),
            "é³´é–€": (34.1775, 134.6094),
            "é‡‘åˆ€æ¯”ç¾…å®®": (34.1847, 133.8197),
            "å±‹å³¶": (34.3522, 134.0934),
            "å°è±†å³¶": (34.4922, 134.2934),
            "ç›´å³¶": (34.4622, 133.9934),
        }
        
        print(f"ğŸ“Š åº§æ¨™ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: {len(self.coordinates_db)}ä»¶ã®åœ°åã‚’æº–å‚™")
    
    def geocode_places(self, db):
        """åº§æ¨™ã®ãªã„åœ°åã«ä¸€æ‹¬ã§åº§æ¨™ã‚’ä»˜ä¸"""
        print("\nğŸ—ºï¸ 4. è‡ªå‹•ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å®Ÿè¡Œ")
        print("-" * 40)
        
        # åº§æ¨™ã®ãªã„åœ°åã‚’å–å¾—
        ungeocoded_places = db.get_places_without_coordinates()
        if not ungeocoded_places:
            print("âœ… å…¨ã¦ã®åœ°åã«åº§æ¨™ãŒè¨­å®šæ¸ˆã¿ã§ã™")
            return 0
        
        print(f"ğŸ” åº§æ¨™ãªã—åœ°å: {len(ungeocoded_places)}ä»¶")
        
        updated_count = 0
        
        for place in ungeocoded_places:
            place_name = place['place_name']
            place_id = place['place_id']
            
            # å®Œå…¨ä¸€è‡´æ¤œç´¢
            if place_name in self.coordinates_db:
                lat, lng = self.coordinates_db[place_name]
                db.update_place_coordinates(place_id, lat, lng)
                print(f"âœ… {place_name}: åº§æ¨™æ›´æ–° ({lat}, {lng})")
                updated_count += 1
                continue
            
            # éƒ¨åˆ†ä¸€è‡´æ¤œç´¢ï¼ˆåœ°åãŒå«ã¾ã‚Œã‚‹å ´åˆï¼‰
            found = False
            for db_place, coords in self.coordinates_db.items():
                if db_place in place_name or place_name in db_place:
                    lat, lng = coords
                    db.update_place_coordinates(place_id, lat, lng)
                    print(f"âœ… {place_name}: åº§æ¨™æ›´æ–° ({lat}, {lng}) [éƒ¨åˆ†ãƒãƒƒãƒ: {db_place}]")
                    updated_count += 1
                    found = True
                    break
            
            if not found:
                print(f"ğŸ” {place_name}: åº§æ¨™ä¸æ˜")
        
        return updated_count


def run_full_extraction():
    """å®Œå…¨ãƒ‡ãƒ¼ã‚¿æ‹¡å……ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆåœ°åæŠ½å‡º + ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼‰ã®å®Ÿè¡Œ"""
    print("ğŸš€ æ–‡è±ªã‚†ã‹ã‚Šåœ°å›³ã‚·ã‚¹ãƒ†ãƒ  - å®Œå…¨ãƒ‡ãƒ¼ã‚¿æ‹¡å……é–‹å§‹")
    print("=" * 70)
    
    start_time = time.time()
    
    # 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
    print("\nğŸ“Š 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–")
    print("-" * 40)
    db = BungoDB()
    print("âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šå®Œäº†")
    
    # 2. é’ç©ºæ–‡åº«åœ°åæŠ½å‡ºã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
    print("\nğŸ” 2. é’ç©ºæ–‡åº«åœ°åæŠ½å‡ºã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–")
    print("-" * 40)
    
    aozora_extractor = AozoraExtractor()
    ginza_extractor = GinzaPlaceExtractor() 
    simple_extractor = SimplePlaceExtractor()
    
    print("âœ… å…¨æŠ½å‡ºå™¨åˆæœŸåŒ–å®Œäº†")
    
    # 3. é’ç©ºæ–‡åº«ã‹ã‚‰ã®åœ°åæŠ½å‡ºå®Ÿè¡Œ
    print("\nğŸï¸ 3. é’ç©ºæ–‡åº«åœ°åæŠ½å‡ºå®Ÿè¡Œ")
    print("-" * 40)
    
    # æ‹¡å¼µä½œå“ãƒªã‚¹ãƒˆã§åœ°åæŠ½å‡ºï¼ˆæœ¬ç•ªå®Ÿè¡Œï¼‰
    extended_works = aozora_extractor.get_extended_works()
    total_places = 0
    
    print(f"ğŸ“š å¯¾è±¡ä½œå“æ•°: {len(extended_works)}ä½œå“")
    unique_authors = set(w['author_name'] for w in extended_works)
    print(f"ğŸ“ å¯¾è±¡ä½œè€…æ•°: {len(unique_authors)}å")
    
    for idx, work_info in enumerate(extended_works, 1):
        print(f"\nğŸ“š {idx}. {work_info['author_name']} - {work_info['title']}")
        print("   " + "-" * 45)
        
        try:
            # ä½œè€…ç™»éŒ²
            author_id = db.upsert_author(work_info['author_name'])
            
            # ä½œå“ç™»éŒ²
            work_id = db.upsert_work(
                author_id=author_id,
                title=work_info['title'],
                wiki_url=work_info.get('text_url', '')
            )
            
            # é’ç©ºæ–‡åº«ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
            text = aozora_extractor.download_and_extract_text(work_info['text_url'])
            
            if not text:
                print("   âŒ ãƒ†ã‚­ã‚¹ãƒˆå–å¾—å¤±æ•—")
                continue
            
            print(f"   ğŸ“„ ãƒ†ã‚­ã‚¹ãƒˆé•·: {len(text):,}æ–‡å­—")
            
            # GiNZAåœ°åæŠ½å‡ºï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‚µã‚¤ã‚ºåˆ¶é™è€ƒæ…®ï¼‰
            test_text = text[:30000]  # 30KBåˆ¶é™
            ginza_places = ginza_extractor.extract_places_from_text(
                work_id=work_id, 
                text=test_text, 
                aozora_url=work_info['text_url']
            )
            
            # æ­£è¦è¡¨ç¾åœ°åæŠ½å‡ºï¼ˆå…¨ãƒ†ã‚­ã‚¹ãƒˆï¼‰
            simple_places = simple_extractor.extract_places_from_text(
                work_id=work_id, 
                text=text,
                aozora_url=work_info['text_url']
            )
            
            print(f"   ğŸ”¬ GiNZAæŠ½å‡º: {len(ginza_places)}å€‹")
            print(f"   ğŸ“ æ­£è¦è¡¨ç¾æŠ½å‡º: {len(simple_places)}å€‹")
            
            # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«åœ°åä¿å­˜
            ginza_saved = 0
            simple_saved = 0
            
            # GiNZAåœ°åã‚’ä¿å­˜
            for place in ginza_places:
                try:
                    place_id = db.upsert_place(
                        work_id=work_id,
                        place_name=place.place_name,
                        before_text=place.before_text,
                        sentence=place.sentence,
                        after_text=place.after_text,
                        aozora_url=place.aozora_url,
                        extraction_method=place.extraction_method,
                        confidence=place.confidence
                    )
                    ginza_saved += 1
                except Exception as e:
                    print(f"     âš ï¸ GiNZAåœ°åä¿å­˜ã‚¨ãƒ©ãƒ¼: {place.place_name} - {e}")
            
            # æ­£è¦è¡¨ç¾åœ°åã‚’ä¿å­˜
            for place in simple_places:
                try:
                    place_id = db.upsert_place(
                        work_id=work_id,
                        place_name=place.place_name,
                        before_text=place.before_text,
                        sentence=place.sentence,
                        after_text=place.after_text,
                        aozora_url=place.aozora_url,
                        extraction_method=place.extraction_method,
                        confidence=place.confidence
                    )
                    simple_saved += 1
                except Exception as e:
                    print(f"     âš ï¸ æ­£è¦è¡¨ç¾åœ°åä¿å­˜ã‚¨ãƒ©ãƒ¼: {place.place_name} - {e}")
            
            total_saved = ginza_saved + simple_saved
            print(f"   ğŸ’¾ DBä¿å­˜: {total_saved}å€‹ (GiNZA: {ginza_saved}, æ­£è¦è¡¨ç¾: {simple_saved})")
            total_places += total_saved
            
        except Exception as e:
            print(f"   âŒ ä½œå“å‡¦ç†ã‚¨ãƒ©ãƒ¼: {e}")
            continue
    
    # 4. è‡ªå‹•ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å®Ÿè¡Œ
    geocoding_engine = GeocodingEngine()
    updated_count = geocoding_engine.geocode_places(db)
    
    # 5. çµæœã‚µãƒãƒªãƒ¼
    print("\nğŸ¯ 5. å®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼")
    print("-" * 40)
    
    # æœ€çµ‚çµ±è¨ˆ
    authors_count = db.get_authors_count()
    works_count = db.get_works_count()
    places_count = db.get_places_count()
    places_with_coords = db.get_places_with_coordinates_count()
    
    end_time = time.time()
    execution_time = end_time - start_time
    
    print(f"ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€çµ‚çŠ¶æ³:")
    print(f"   ğŸ“š ä½œè€…: {authors_count}ä»¶")
    print(f"   ğŸ“– ä½œå“: {works_count}ä»¶")
    print(f"   ğŸï¸ åœ°å: {places_count}ä»¶")
    print(f"   ğŸ—ºï¸ åº§æ¨™ã‚ã‚Š: {places_with_coords}ä»¶ ({places_with_coords/places_count*100:.1f}%)")
    print(f"   ğŸ¯ ä»Šå›æ›´æ–°: {updated_count}ä»¶")
    print(f"   â±ï¸ å®Ÿè¡Œæ™‚é–“: {execution_time:.1f}ç§’")
    
    print(f"\nğŸ‰ å®Œå…¨ãƒ‡ãƒ¼ã‚¿æ‹¡å……ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Œäº†ï¼")
    print("=" * 70)
    
    # åœ°åæŠ½å‡ºçµæœã®ã‚µãƒ³ãƒ—ãƒ«è¡¨ç¤º
    print(f"\nğŸ“ æŠ½å‡ºåœ°åã‚µãƒ³ãƒ—ãƒ« (æœ€æ–°10ä»¶):")
    print("-" * 40)
    
    recent_places = db.get_recent_places(limit=10)
    for place in recent_places:
        coord_status = f"({place.get('lat', 'N/A')}, {place.get('lng', 'N/A')})" if place.get('lat') else "åº§æ¨™ãªã—"
        print(f"   â€¢ {place['place_name']} ({place['extraction_method']}) - ä¿¡é ¼åº¦: {place['confidence']:.2f}")
        print(f"     ä½œå“: {place['work_title']} / ä½œè€…: {place['author_name']}")
        print(f"     åº§æ¨™: {coord_status}")
        print(f"     æ–‡è„ˆ: {place['sentence'][:60]}...")
        print()


if __name__ == "__main__":
    run_full_extraction() 